<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Job Logging • redcapcustodian</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Job Logging">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">redcapcustodian</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.25.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/credential-scraping.html">Credential Scraping</a></li>
    <li><a class="dropdown-item" href="../articles/custom_rscript.html">Custom Rscript</a></li>
    <li><a class="dropdown-item" href="../articles/delete-erroneous-survey-reminders.html">Deleting Erroneous Survey Reminders</a></li>
    <li><a class="dropdown-item" href="../articles/developer_notes.html">Developer Notes for REDCap Custodian</a></li>
    <li><a class="dropdown-item" href="../articles/expire_user_project_rights.html">expire_user_project_rights</a></li>
    <li><a class="dropdown-item" href="../articles/friday-call-demo-setup.html">REDCap Custodian Friday Call Demo Credentials Setup</a></li>
    <li><a class="dropdown-item" href="../articles/friday-call-demo.html">REDCap Custodian Friday Call Demo</a></li>
    <li><a class="dropdown-item" href="../articles/job_logging.html">Job Logging</a></li>
    <li><a class="dropdown-item" href="../articles/randomization-management.html">Randomization Management</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ctsit/redcapcustodian/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="job_logging_files/kePrint-0.0.1/kePrint.js"></script><link href="job_logging_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Job Logging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctsit/redcapcustodian/blob/master/vignettes/job_logging.Rmd" class="external-link"><code>vignettes/job_logging.Rmd</code></a></small>
      <div class="d-none name"><code>job_logging.Rmd</code></div>
    </div>

    
    
<p>REDCap Custodian includes its own job logging facility. The system is
designed to log each job run to a single row in a MYSQL database. With
as little a four lines of code, you can log job success or failure along
with a message. e.g.,</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctsit.github.io/redcapcustodian/" class="external-link">redcapcustodian</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gaborcsardi/dotenv" class="external-link">dotenv</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/init_etl.html">init_etl</a></span><span class="op">(</span><span class="st">"my_useful_script"</span>, log_db_drv <span class="op">=</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># do some stuff ...</span></span>
<span></span>
<span><span class="fu"><a href="../reference/log_job_success.html">log_job_success</a></span><span class="op">(</span><span class="st">"It worked!"</span><span class="op">)</span></span></code></pre></div>
<p>The code in above would produce a row in the logging database like
that shown in below.</p>
<table class="table table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;">
job_duration
</th>
<th style="text-align:left;">
job_summary_data
</th>
<th style="text-align:left;">
level
</th>
<th style="text-align:left;">
log_date
</th>
<th style="text-align:left;">
project
</th>
<th style="text-align:left;">
instance
</th>
<th style="text-align:left;">
script_name
</th>
<th style="text-align:left;">
script_run_time
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:right;">
0.1682405
</td>
<td style="text-align:left;">
It worked!
</td>
<td style="text-align:left;">
SUCCESS
</td>
<td style="text-align:left;">
2024-10-24 17:53:04
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
my_useful_script
</td>
<td style="text-align:left;">
2024-10-24 17:53:04
</td>
</tr></tbody>
</table>
<div class="section level2">
<h2 id="behind-the-scenes">Behind the scenes<a class="anchor" aria-label="anchor" href="#behind-the-scenes"></a>
</h2>
<p>That’s a tiny script, but a lot is happening. Let’s decode what’s
going on in those few lines.</p>
<div class="section level3">
<h3 id="librarydotenv">
<code>library(dotenv)</code><a class="anchor" aria-label="anchor" href="#librarydotenv"></a>
</h3>
<p>REDCap Custodian uses the <code>dotenv</code> package to read files
of name-value pairs into the environment of the script. By default it
reads <code>.env</code> from the current directory. To make logging work
correctly, that <code>.env</code> file will need a stanza like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="dt">LOG_DB_NAME</span><span class="ot">=</span><span class="st">rcc_log</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="dt">LOG_DB_HOST</span><span class="ot">=</span><span class="st">127.0.0.1</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="dt">LOG_DB_USER</span><span class="ot">=</span><span class="st">rcc_log</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="dt">LOG_DB_PASSWORD</span><span class="ot">=</span><span class="st">password</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="dt">LOG_DB_PORT</span><span class="ot">=</span><span class="dv">9000</span></span></code></pre></div>
<p>The “LOG_DB_*” strings are the environment variable names
<code>redcapcustodian</code> uses to locate the MySQL DB where it stores
the logging data. You need to use these names and the values need to
point at a MySQL table on a MySQL server.</p>
</div>
<div class="section level3">
<h3 id="init_etl">
<code>init_etl()</code><a class="anchor" aria-label="anchor" href="#init_etl"></a>
</h3>
<p><code>init_etl("my_useful_script")</code> sets the
<code>script_name</code> env variable to “my_useful_script”, sets the
<code>script_run_time</code> env variable to the current date and time,
and it verifies the connection to the database described by the
“LOG_DB_*” environment variables. If the database is there,
<code><a href="../reference/init_etl.html">init_etl()</a></code> quietly exits. If the database is not there you
will see</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>Warning<span class="sc">:</span> Failed to connect to log DB<span class="sc">:</span> rcc_log_bad</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>The reason given was<span class="sc">:</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a> Error<span class="sc">:</span> Failed to connect<span class="sc">:</span> Access denied <span class="cf">for</span> user <span class="st">'rcc_log'</span><span class="sc">@</span><span class="st">'%'</span> to database <span class="st">'rcc_log_bad'</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="log_job_success">
<code>log_job_success()</code><a class="anchor" aria-label="anchor" href="#log_job_success"></a>
</h3>
<p><code>log_job_success("It worked!")</code> writes a row to the
logging database like the example above.</p>
</div>
</div>
<div class="section level2">
<h2 id="failed-jobs">Failed jobs<a class="anchor" aria-label="anchor" href="#failed-jobs"></a>
</h2>
<p>When jobs fail, you might want to log that condition, for that, call
<code><a href="../reference/log_job_failure.html">log_job_failure()</a></code>. As with <code><a href="../reference/log_job_success.html">log_job_success()</a></code>,
you can provide a message to give more detail about what went wrong.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/log_job_failure.html">log_job_failure</a></span><span class="op">(</span><span class="st">"input dataframe was empty"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="more-detailed-messages">More detailed messages<a class="anchor" aria-label="anchor" href="#more-detailed-messages"></a>
</h2>
<p>Logging “It worked!” or “input dataframe was empty” is fine, but
often, you want to provide more detail about a job’s activities. Chances
are you have some useful facts in R objects already. It is a simple
matter to assemble those objects into a list, convert the list object
into a text string with using JSON libraries, and use that string as the
job’s message. If you wanted to report some updates you made to the
‘iris’ database, you might log it like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/init_etl.html">init_etl</a></span><span class="op">(</span><span class="st">"iris_updater"</span><span class="op">)</span></span>
<span><span class="co"># Do some stuff</span></span>
<span><span class="co"># ...</span></span>
<span><span class="va">iris_updates</span> <span class="op">&lt;-</span> <span class="va">iris</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="va">Species</span><span class="op">)</span></span>
<span><span class="co"># ...</span></span>
<span><span class="co"># success!</span></span>
<span><span class="va">log_message</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/lst.html" class="external-link">lst</a></span><span class="op">(</span><span class="va">iris_updates</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/log_job_success.html">log_job_success</a></span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">log_message</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code>summary</code> value can contain any number of JSON-encoded
objects. That said, plan them carefully. Ask what questions you will
want to answer later after a job has run. The package authors have found
the most common questions posed are “Why did this value change?”, “Who
(or what) set the value?”, and “When did this change?” Store as little
information as is needed to answer those questions succinctly. If you
provide lots of different objects, it might make for a pile of log data
to sift through later. We’ve found we can usually meet these needs by
including minimal dataframes of the data written by the job.</p>
<p>If you have multiple jobs writing to the same dataset, consider the
value of self-consistency across those jobs. If every update operation
of the <em>invoice</em> table is logged in an object named
<em>invoice_updates</em>, you can more easily search across those
jobs.</p>
</div>
<div class="section level2">
<h2 id="reading-back-log-data">Reading back log data<a class="anchor" aria-label="anchor" href="#reading-back-log-data"></a>
</h2>
<p>Reading back the log data presents a few challenges. When you are
answering the “Who? What? When? Why?” questions you often have to search
across multiple log events to find the job run that made the change. You
can filter the log data to the time frame or jobs of interest, but you
will still have to search multiple job summaries to find the one that
made the change you care about.</p>
<p>If you encoded the job summary data with JSON, you’ll need to decode
it, but <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON</a></code> is not vectorized. You’ll have
to iterate over the log records. Also, you’ll want to unnest the job
summary objects returned by <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">jsonlite::fromJSON</a></code>. REDCap
Custodian provides the function
<code><a href="../reference/unnest_job_summary_data_json_object.html">unnest_job_summary_data_json_object()</a></code> to help with these
operations. e.g.,</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_package_scope_var.html">get_package_scope_var</a></span><span class="op">(</span><span class="st">"log_con"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">log_conn</span>, <span class="st">"rcc_job_log"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">script_name</span> <span class="op">==</span> <span class="st">"iris_updater"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_tail</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="../reference/unnest_job_summary_data_json_object.html">unnest_job_summary_data_json_object</a></span><span class="op">(</span><span class="va">log_data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="st">"iris_updates"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">kbl</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The output from <code>unnest_job_summary_data_json_object</code>,
once unnested, would look like:</p>
<div class="float">
<img src="unnest_job_summary_data_json_object_output.png" width="744" alt="Example output from unnest_job_summary_data_json_object"><div class="figcaption">Example output from
unnest_job_summary_data_json_object</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Chase, Laurence James-Woodley, Kyle Chesney, Michael Bentz, Sai Pavan Kamma.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
