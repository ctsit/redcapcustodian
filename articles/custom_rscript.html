<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="redcapcustodian">
<title>Custom Rscript • redcapcustodian</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom Rscript">
<meta property="og:description" content="redcapcustodian">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">redcapcustodian</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/credential-scraping.html">Credential Scraping</a>
    <a class="dropdown-item" href="../articles/custom_rscript.html">Custom Rscript</a>
    <a class="dropdown-item" href="../articles/developer_notes.html">Developer Notes for REDCap Custodian</a>
    <a class="dropdown-item" href="../articles/expire_user_project_rights.html">expire_user_project_rights</a>
    <a class="dropdown-item" href="../articles/friday-call-demo-setup.html">REDCap Custodian Friday Call Demo Credentials Setup</a>
    <a class="dropdown-item" href="../articles/friday-call-demo.html">REDCap Custodian Friday Call Demo</a>
    <a class="dropdown-item" href="../articles/randomization-management.html">Randomization Management</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ctsit/redcapcustodian/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Custom Rscript</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ctsit/redcapcustodian/blob/HEAD/vignettes/custom_rscript.Rmd" class="external-link"><code>vignettes/custom_rscript.Rmd</code></a></small>
      <div class="d-none name"><code>custom_rscript.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="writing-your-own-redcapcustodian-rscripts">Writing your own redcapcustodian Rscripts<a class="anchor" aria-label="anchor" href="#writing-your-own-redcapcustodian-rscripts"></a>
</h2>
<p>In its most basic use, redcapcustodian need only be load as a library
in an Rscript. To automate a report or ETL already in redcapcustodian,
you need only build the image, write a configuration file and
instantiate the container from that image with that config file. Yet it
allows for extensive customization that builds upon the framework it
provides.</p>
<div class="section level3">
<h3 id="writing-your-own-rscripts">Writing your own Rscripts<a class="anchor" aria-label="anchor" href="#writing-your-own-rscripts"></a>
</h3>
<p>You can write your own Rscript to accomplish a task against one or
more REDCap hosts or projects. That script should load the
<em>redcapcustodian</em> package. To make your own script clone the
redcap custodian repository, then copy the contents of <a href="https://github.com/ctsit/redcapcustodian/tree/master/study_template/" class="external-link"><code>study_template</code></a>
to a new folder</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@github.com:ctsit/redcapcustodian.git</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-r</span> redcapcustodian/site_template my.study</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../my.study</span></code></pre></div>
<p>Rename the Rstudio project to match your study’s name:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> example.Rproj my.study.Rproj</span></code></pre></div>
<p>Then you can open the new project in Rstudio.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> my.study.Rproj</span></code></pre></div>
<p>If this is your first redcapcustodian project, it might help to
follow the example in <code><a href="../articles/friday-call-demo.html">vignette("friday-call-demo")</a></code> in
RStudio. That example was created to present REDCap Custodian to the
REDCap community.</p>
<p>If this is not your first REDCap Custodian rodeo, you might remember
what you need to do, but we offer this guide to help avoid some
mis-steps.</p>
</div>
<div class="section level3">
<h3 id="configure-your-interfaces">Configure your interfaces<a class="anchor" aria-label="anchor" href="#configure-your-interfaces"></a>
</h3>
<p>You’ll need to talk to at least a REDCap or a MySQL database. You
will probably want both. Rename the <code>example.env</code> to
<code>testing.env</code> and configure it for development on your
computer. That file is composed of five sections.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="va">INSTANCE</span><span class="op">=</span>Development</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">TIME_ZONE</span><span class="op">=</span>America/New_York</span></code></pre></div>
<p><code>INSTANCE</code> names the REDCap system or <em>instance</em>
you’ll be talking to. This file assumes you are talking to only one
REDCap in your script. There are other tools for multiple-instances.</p>
<p><code>TIME_ZONE</code> should be the local timezone of your REDCap
instance. Note that REDCap time facts in local time. The MariaDB driver
and the Lubridate library default to UTC. That can get complicated. Be
careful with time. For more details see <a href="https://gist.github.com/pbchase/ed55ab5dacbcc5d8a702a9cb935cccb5" class="external-link"><code>stupid_date_tricks.R</code></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Email config</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">EMAIL_TO</span><span class="op">=</span>you@example.org</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="va">EMAIL_CC</span><span class="op">=</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="va">EMAIL_FROM</span><span class="op">=</span>please-do-not-reply@example.org</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="va">SMTP_SERVER</span><span class="op">=</span>smtp.example.org</span></code></pre></div>
<p>Many scripts will need to send emails to the developers, the REDCap
Admin or a study coordinator. Set the email values appropriately for
your site and study needs.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># REDCap DB Credentials</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">REDCAP_DB_NAME</span><span class="op">=</span>DB_NAME</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="va">REDCAP_DB_HOST</span><span class="op">=</span>DB_HOST</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="va">REDCAP_DB_USER</span><span class="op">=</span>DB_USER</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">REDCAP_DB_PASSWORD</span><span class="op">=</span>DB_PASSWORD</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="va">REDCAP_DB_PORT</span><span class="op">=</span>3306</span></code></pre></div>
<p>If you need to talk directly to your REDCap database, you’ll need to
provide the credentials to that database. If you are doing development
work, enter the credentials for your local MySQL Database.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ETL DB Credentials</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ETL_DB_NAME<span class="ot">=</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>ETL_DB_HOST<span class="ot">=</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ETL_DB_USER<span class="ot">=</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>ETL_DB_PASSWORD<span class="ot">=</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>ETL_DB_SCHEMA<span class="ot">=</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>ETL_DB_PORT<span class="ot">=</span></span></code></pre></div>
<p>The task or study you are working on might need its own database
tables. They might hold data that does not need to be in REDCap or data
that does not fit well in the REDCap data model. If your REDCap projects
are very large (think 30K records or more) you might want to mirror some
or all of your REDCap project into MySQL to run more performant queries.
If any of that describes your need, its best to not mix those tables
with the REDCap tables. That second MySQL table will have its own
credentials and your scripts will need access to those secrets. The
“ETL” prefix is nothing special, it means “Extract, Transform, and
Load”–a common term in database management. You can use any prefix you
like, but you <em>will</em> want to use a prefix. The database
connection functions depend on it.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Log DB Credentials</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_NAME</span><span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_HOST</span><span class="op">=</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_USER</span><span class="op">=</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_PASSWORD</span><span class="op">=</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_SCHEMA</span><span class="op">=</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="va">LOG_DB_PORT</span><span class="op">=</span></span></code></pre></div>
<p>REDCap Custodian provides a rich framework for logging both success
and failure of automated processes. By default, it logs activity to a
MySQL databse of your choosing. This should <em>not</em> be your REDCap
database. It’s completely reasonable to log a study’s activity into your
study database, but if you don’t have a study database, a shared logging
database is a good thing. Make sure to set <code>LOG_DB_</code>
values.</p>
</div>
<div class="section level3">
<h3 id="redcap-api-credential-management">REDCap API credential management<a class="anchor" aria-label="anchor" href="#redcap-api-credential-management"></a>
</h3>
<p>It’s possible to do credential management with environment variables,
but it quickly gets tedious. It get’s very tedious if you have to manage
multiple API tokens. To address that, REDCap custodian provides a few
credential management functions to help you make an use a local dataset
of REDCAp API credentials. See
<code><a href="../articles/credential-scraping.html">vignette("credential-scraping")</a></code> for an example of how to do
it. Read down through <em>Scraping a server’s API tokens and putting
them in a local sqlite DB</em></p>
</div>
<div class="section level3">
<h3 id="create-your-scripts-in-the-right-folder">Create your scripts in the right folder<a class="anchor" aria-label="anchor" href="#create-your-scripts-in-the-right-folder"></a>
</h3>
<p>Create scripts that will move or clean data in the <code>etl</code>
folder. Create reports in the <code>reports</code> folder. These aren’t
rules, but they are useful conventions. Each of these has been excluded
from the package build process so <em>if</em> you make a package the
code in these folders won’t cause warnings in the build.</p>
</div>
<div class="section level3">
<h3 id="tiny-script-example">Tiny script example<a class="anchor" aria-label="anchor" href="#tiny-script-example"></a>
</h3>
<p>REDCap custodian includes an example report script to describe your
REDCap users at <a href="https://github.com/ctsit/redcapcustodian/tree/master/report/redcap_user_lifecycle.Rmd" class="external-link">REDCap
User Lifecycle</a>. It provides an example of a report you could run
against your own REDCap system. We also have an example of the <a href="https://github.com/ctsit/redcapcustodian/tree/master/vignettes/redcap_user_lifecycle.pdf" class="external-link">report
output</a> from the University of Florida CTSI REDCap system with
annotations that explain what it tells you about the history and
activity of the UF system.</p>
</div>
<div class="section level3">
<h3 id="logging">Logging<a class="anchor" aria-label="anchor" href="#logging"></a>
</h3>
<p>REDCap Custodian provides valuable logging that reduce the stress of
running unattended jobs writing data to important things. To use the
logging you need to create a MySQL/Maria DB, put its credentials in your
environment file as described above, load the redcapcustodian package in
your script, and initialize the logging. You can and should also log
success at the end of the script and log warnings or failure where your
script can detect them. Here’s an actual script that makes some changes
in the redcap backend and logs what is did:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ctsit.github.io/redcapcustodian/" class="external-link">redcapcustodian</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rcc.billing</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gaborcsardi/dotenv" class="external-link">dotenv</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/init_etl.html">init_etl</a></span><span class="op">(</span><span class="st">"update_project_billable_attribute"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/connect_to_redcap_db.html">connect_to_redcap_db</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">diff_output</span> <span class="op">&lt;-</span> <span class="fu">update_billable_by_ownership</span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sync_activity</span> <span class="op">&lt;-</span> <span class="fu">redcapcustodian</span><span class="fu">::</span><span class="fu"><a href="../reference/sync_table.html">sync_table</a></span><span class="op">(</span></span>
<span>  conn <span class="op">=</span> <span class="va">conn</span>,</span>
<span>  table_name <span class="op">=</span> <span class="st">"redcap_entity_project_ownership"</span>,</span>
<span>  primary_key <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  data_diff_output <span class="op">=</span> <span class="va">diff_output</span>,</span>
<span>  insert <span class="op">=</span> <span class="cn">F</span>,</span>
<span>  update <span class="op">=</span> <span class="cn">T</span>,</span>
<span>  delete <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">activity_log</span> <span class="op">&lt;-</span> <span class="va">diff_output</span><span class="op">$</span><span class="va">update_records</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">pid</span>, <span class="va">billable</span>, <span class="va">updated</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/log_job_success.html">log_job_success</a></span><span class="op">(</span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html" class="external-link">toJSON</a></span><span class="op">(</span><span class="va">activity_log</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>That script generated this log record in the log database:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> `rcc_job_log` (`job_duration`, `job_summary_data`, `level`, `log_date`, `script_name`, `script_run_time`) <span class="kw">VALUES</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>(<span class="fl">80.16091799736023</span>, <span class="st">'[{</span><span class="ch">\"</span><span class="st">pid</span><span class="ch">\"</span><span class="st">:15,</span><span class="ch">\"</span><span class="st">billable</span><span class="ch">\"</span><span class="st">:1,</span><span class="ch">\"</span><span class="st">updated</span><span class="ch">\"</span><span class="st">:1657139254},{</span><span class="ch">\"</span><span class="st">pid</span><span class="ch">\"</span><span class="st">:16,</span><span class="ch">\"</span><span class="st">billable</span><span class="ch">\"</span><span class="st">:1,</span><span class="ch">\"</span><span class="st">updated</span><span class="ch">\"</span><span class="st">:1657139254},{</span><span class="ch">\"</span><span class="st">pid</span><span class="ch">\"</span><span class="st">:22,</span><span class="ch">\"</span><span class="st">billable</span><span class="ch">\"</span><span class="st">:1,</span><span class="ch">\"</span><span class="st">updated</span><span class="ch">\"</span><span class="st">:1657139254}]'</span>, <span class="st">'SUCCESS'</span>, <span class="st">'2022-07-06 20:28:54.494426'</span>, <span class="st">'update_project_billable_attribute'</span>, <span class="st">'2022-07-06 20:27:34.322926'</span>);</span></code></pre></div>
<p><code>job_summary_data</code> is a JSON object of all of the data
updated. It’s hard for humans to read but 100% machine parsable.</p>
<p>To query the job log, use your favorite DB client. If you are a
Tidyverse developer, dplyr::tbl() is a fantastic DB client.</p>
</div>
<div class="section level3">
<h3 id="writing-good-data-management-code">Writing good data management code<a class="anchor" aria-label="anchor" href="#writing-good-data-management-code"></a>
</h3>
<p>This is too big a topic to cover here but it is central to the entire
effort so it can’t entirely be ignored. The best favor you can do for
yourself and your customers, is to use good tools. At CTS-IT, we have
identified a toolset that allows us to be efficient in our programming.
We strongly recommend these tools:</p>
<ul>
<li>R for 99% of our data programming.</li>
<li>RStudio as the easiest possible integrated development environment
for R programming.</li>
<li>Tidyverse as the most effective dialect of R to code in.</li>
<li>REDCapR for 99% of REDCap API access.</li>
<li>DBI and dplyr::tbl() for access to SQL tables.</li>
</ul>
<p>It’s also wise to have a good software development workflow. At
CTS-IT we use these tools and rules:</p>
<ul>
<li>Use version control for all code.</li>
<li>If you have more than one developer, do code review of
<em>everything</em>.</li>
<li>If you have more than one developer, use the Github workflow of pull
requests, review, and merges to manage code review.</li>
<li>Never put secrets in your code. Put secrets environment variables,
datasets, or other systems.</li>
<li>Never put secrets in version control.</li>
<li>Don’t put configuration in code. Instead put it in the environment
variables or datasets.</li>
</ul>
<p>Stop and think about architecture and study lifecycle.</p>
<ul>
<li>Don’t mix two studies in one git repository.</li>
<li>Don’t be afraid to make an R package just for one study.</li>
<li>Think about names of things. Pick good names. Don’t be afraid to
rename poorly named things.</li>
</ul>
</div>
<div class="section level3">
<h3 id="automation-with-container-infrastructure">Automation with container infrastructure<a class="anchor" aria-label="anchor" href="#automation-with-container-infrastructure"></a>
</h3>
<p>If you need something to run periodically, you need to make it easy
to run with all of its dependencies packaged up and you need to schedule
it. The modern way to package dependencies is to put them all into a
container, add your application and run the container. REDCap Custodian
supports containerization with Docker. The <a href="https://github.com/ctsit/redcapcustodian/tree/master/study_template/Dockerfile" class="external-link"><code>./study_template/Dockerfile</code></a>
is template you can use to containerize your RScript and RMarkdown.
Adapt it to your needs and build the container with <a href="https://github.com/ctsit/redcapcustodian/tree/master/build.sh" class="external-link">./build.sh</a>.
If you have good container infrastructure, use it to build and deploy
your containers.</p>
<p>Running automated R Markdown reports from docker requires the use of
an Rmd renderer. <a href="https://github.com/ctsit/redcapcustodian/tree/master/study_template/report/render_report.R" class="external-link">render_report.R</a>
contains functionality to knit an Rmd, email it and then log the job
run. The Rmd script name is passed as a command line argument to <a href="https://github.com/ctsit/redcapcustodian/tree/master/study_template/report/render_report.R" class="external-link">render_report.R</a>
via cron. Refer to <a href="https://github.com/ctsit/redcapcustodian/tree/master/study_template/cron/sample_report" class="external-link">sample_report</a>
for an example cron job.</p>
</div>
<div class="section level3">
<h3 id="automation-with-linux-and-cron">Automation with Linux and cron<a class="anchor" aria-label="anchor" href="#automation-with-linux-and-cron"></a>
</h3>
<p>If you have no container management infrastructure available to you,
but your IT support provides Linux hosts, have them build one for you,
install Docker on it, and give you <code>sudo su</code> access. That
will allow you to build and run docker images on the host.</p>
<p>Login, git clone redcapcustodian’s git repository, cd into the
repository and build the image:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@github.com:ctsit/redcapcustodian.git</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> redcapcustodian</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ./build.sh</span></code></pre></div>
<p>Do the same for your own study repository:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@github.com:ctsit/rcc.billing.git</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> rcc.billing</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ./build.sh</span></code></pre></div>
<p>To clone a private repository, you’ll need a deployment key. See <a href="https://docs.github.com/en/developers/overview/managing-deploy-keys#deploy-keys" class="external-link">Deploy
Keys</a> for instructions.</p>
<p>Once you’ve built the study container on your Docker host, create a
cron entry to run it with the right parameters and secrets. To run the
above script, <code>etl/update_project_billable_attribute.R</code>
regularly on a host you call ‘prod’, create a cron entry for it:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> su</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&lt;&lt;END&gt;&gt;</span> prod/cron/update_project_billable_attribute</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st"># run update_project_billable_attribute at 6:07 a.m.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">7 6 * * * root /usr/bin/docker run --rm --env-file /rcc/rcc.billing/prod.env rcc.billing Rscript rcc.billing/etl/update_project_billable_attribute.R</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">END</span></span></code></pre></div>
<p>The build script has a <code>-d</code> option to automatically deploy
the cron file and build time. If you place your cron file in the
<code>./cron/</code> folder at the root of the repository, and build
with <code>./build.sh -d</code>, the build script will copy the file to
<code>/etc/cron.d</code> and give it a guaranteed unique name.</p>
</div>
<div class="section level3">
<h3 id="using-version-control">Using version control<a class="anchor" aria-label="anchor" href="#using-version-control"></a>
</h3>
<p>Once you go down this road of writing your own scripts, you should be
very concerned about preserving them. One of the best ways to do this is
via git version control. Initialize a new software repository in your
<code>./my.study</code> folder. Then add a remote pointing at a new
empty repository at GitHub, GitLab, BitBucket or your favorite Git
repository hosting service, and push to that new repo.</p>
</div>
<div class="section level3">
<h3 id="adding-a-custom-package">Adding a custom package<a class="anchor" aria-label="anchor" href="#adding-a-custom-package"></a>
</h3>
<p>If you want to do complex things in your redcapcustodian Rscripts or
share custom code between them, you might want to add your own R package
just for redcapcustodian work. redcapcustodian supports the development
of such a package within the <code>./my.study/</code> folder.</p>
<p>The RStudio team’s <a href="https://r-pkgs.org/" class="external-link">packaging
guidelines</a> are an excellent guide for package development. They
might seem like a lot to take in, but they solve common problems. They
will help you write better code. You don’t need to submit a package to
CRAN to get value from the packaging guidelines.</p>
<p>To build the latest version of the package as you build a task
container, uncomment these lines in the task’s <code>Dockerfile</code>
and customize them with your package name:</p>
<pre><code># Add, build, and install this study's package
ADD .. /home/rocker/my.study
RUN R CMD build my.study
RUN R CMD INSTALL my.study*.tar.gz
RUN rm -rf my.study</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Philip Chase, Laurence James-Woodley, Kyle Chesney, Michael Bentz.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
